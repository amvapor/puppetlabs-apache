<% if @rewrites -%>
  ## Rewrite rules
  RewriteEngine On
<% if @rewrite_base -%>
  RewriteBase <%= @rewrite_base %>
<% end -%>

<% Array(@rewrites).each do |comment, rewrite_details| -%>
  #<%= comment %>
<%- rewrite_details.fetch('rewrite_conds').each do |commands| -%>
<%- Array(commands).each do |command| -%>
  RewriteCond <%= command %>
<%- end -%>
<% end -%>
<%- rewrite_details.fetch('rewrite_rules').each do |commands| -%>
<%- Array(commands).each do |command| -%>
  RewriteRule <%= command %>
<%- end -%>

<% end -%>
<% end -%>
<%- end -%>
<%# reverse compatibility %>
<% if @rewrite_rule and !@rewrites -%>
  ## Rewrite rules
  RewriteEngine On
<% if @rewrite_base -%>
  RewriteBase <%= @rewrite_base %>
<% end -%>
<% if @rewrite_cond -%>
<% Array(@rewrite_cond).each do |cond| -%>
  RewriteCond <%= cond %>
<% end -%>
<% end -%>
  RewriteRule <%= @rewrite_rule %>
<%- end -%>
